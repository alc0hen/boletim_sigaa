<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Perfil | Boletim App</title>
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .profile-pic {
            width: 100px; height: 100px;
            border-radius: 50%;
            border: 3px solid var(--accent);
            object-fit: cover;
            box-shadow: var(--shadow);
            margin-bottom: 1rem;
        }
        .profile-pic-placeholder {
            width: 100px; height: 100px;
            border-radius: 50%;
            background: var(--bg-main);
            color: var(--accent);
            font-size: 2.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid var(--accent);
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }
    </style>
</head>
<body>
<nav>
    <div class="container nav-content">
        <div class="logo">Meu Perfil</div>
        <a href="{{ url_for('main.dashboard') }}" class="btn-secondary" style="width:auto; padding:8px 16px; margin-top:0;">Voltar</a>
    </div>
</nav>
<div class="container" style="margin-top: 2rem; max-width: 600px;">
    <div class="card profile-header" style="text-align: center; padding: 2rem;">
        {% if user.profile_pic %}
            <img src="{{ user.profile_pic }}" alt="Foto" class="profile-pic">
        {% else %}
            <div class="profile-pic-placeholder" style="margin: 0 auto 1rem auto;">
                {{ user.name[0] if user.name else 'U' }}
            </div>
        {% endif %}
        <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">{{ user.name }}</h2>
        <p style="margin-bottom: 1.5rem;">{{ user.email }}</p>
        <a href="{{ url_for('main.logout') }}" class="btn-logout" style="font-size: 0.8rem; letter-spacing: 1px;">Sair da Conta</a>
    </div>
    <section class="accounts-section" style="margin-top: 2rem;">
        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
            Contas Vinculadas
        </h3>
        <div class="account-list">
            {% for acc in linked_accounts %}
                <div class="account-item {{ 'active' if acc.id == active_account_id else '' }}">
                    <div class="account-info">
                        <span class="inst-badge">{{ acc.institution }}</span>
                        <div class="account-details">
                            <span class="account-username">{{ acc.username }}</span>
                            {% if acc.id == active_account_id %}
                                <span class="account-status">Ativa</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="account-actions">
                        {% if acc.id != active_account_id %}
                            <form action="{{ url_for('main.activate_account', id=acc.id) }}" method="POST">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <button type="submit" class="btn-icon-only" title="Trocar para esta conta">
                                    <i class="bi bi-shuffle"></i>
                                </button>
                            </form>
                        {% endif %}
                        <form action="{{ url_for('main.unlink_account', id=acc.id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja remover esta conta?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn-icon-only btn-danger" title="Remover conta">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="empty-state">Nenhuma conta vinculada.</div>
            {% endfor %}
        </div>
    </section>
    <div style="margin-top: 2rem; text-align: center;">
        <button onclick="openModal()" class="btn-minimal" style="width: 100%; border-style: dashed; padding: 1rem;">
            + Vincular Nova Conta
        </button>
    </div>
</div>
<div id="link-modal" class="modal-overlay">
    <div class="modal-box">
        <button class="modal-close" onclick="closeModal()">âœ•</button>
        <h3 style="margin-bottom: 1.5rem; text-align: center;">Vincular SIGAA</h3>
        {% if error %}
            <div class="alert alert-error">{{ error }}</div>
        {% endif %}
        <form method="POST" action="{{ url_for('main.link_account') }}" onsubmit="startLinkAnimation()">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="inst-selector-container" style="margin-bottom: 1rem;">
                <input type="radio" name="institution" value="IFAL" id="ifal" class="inst-radio" checked>
                <label for="ifal" class="inst-label">IFAL</label>
                <input type="radio" name="institution" value="UFAL" id="ufal" class="inst-radio">
                <label for="ufal" class="inst-label">UFAL</label>
            </div>
            <input type="text" name="username" placeholder="Username" required style="margin-bottom: 1rem;">
            <input type="password" name="password" placeholder="Senha do SIGAA" required style="margin-bottom: 1rem;">
            <button type="submit" id="btn-submit-link">Conectar</button>
        </form>
    </div>
</div>
<div id="login-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:9999; align-items:center; justify-content:center; flex-direction:column;">
    <div class="loading-spinner" style="width:50px; height:50px; border:4px solid rgba(255,255,255,0.1); border-left-color:var(--accent); border-radius:50%;"></div>
    <p id="login-msg" style="margin-top:20px; color:#fff; font-size:1.1rem; text-align:center;">Conectando ao SIGAA...</p>
</div>
<script>
    function openModal() {
        document.getElementById('link-modal').style.display = 'flex';
    }
    function closeModal() {
        document.getElementById('link-modal').style.display = 'none';
    }
    // Close modal on outside click
    document.getElementById('link-modal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    function startLinkAnimation() {
        closeModal();
        const overlay = document.getElementById('login-overlay');
        const msg = document.getElementById('login-msg');
        overlay.style.display = 'flex';
        setTimeout(() => {
            msg.textContent = "Isso pode demorar um pouco se o SIGAA estiver lento...";
        }, 5000);
    }
</script>
</body>
</html>